# ЁЯЪА р╕Др╕│р╣Бр╕Щр╕░р╕Щр╕│р╕Бр╕▓р╕гр╕гр╕▒р╕Щ Migration (р╕нр╕▒р╕Ыр╣Ар╕Фр╕Х)

## ЁЯУЛ р╕кр╕Цр╕▓р╕Щр╕Бр╕▓р╕гр╕Ур╣Мр╕Ыр╕▒р╕Ир╕Ир╕╕р╕Ър╕▒р╕Щ

р╕Ир╕▓р╕Бр╕Бр╕▓р╕гр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Юр╕Ър╕зр╣Ир╕▓:
- тЬЕ **р╕Хр╕▓р╕гр╕▓р╕Зр╕Чр╕╡р╣Ир╕бр╕╡р╕нр╕вр╕╣р╣И**: customers, installment_plans, installment_contracts, installment_payments
- тЭМ **р╕Хр╕▓р╕гр╕▓р╕Зр╕Чр╕╡р╣Ир╕Вр╕▓р╕Фр╕лр╕▓р╕в**: guarantors, contract_history, contract_documents
- тЭМ **р╕Др╕нр╕ер╕▒р╕бр╕Щр╣Мр╕Чр╕╡р╣Ир╕Вр╕▓р╕Фр╕лр╕▓р╕вр╣Гр╕Щр╕Хр╕▓р╕гр╕▓р╕З customers**: id_card, occupation, monthly_income, workplace, work_address, emergency_contact_*
- тЪая╕П **р╕Хр╕▓р╕гр╕▓р╕З installment_plans**: р╕бр╕╡р╣Вр╕Др╕гр╕Зр╕кр╕гр╣Йр╕▓р╕Зр╣Бр╕Хр╕Бр╕Хр╣Ир╕▓р╕Зр╕Ир╕▓р╕Бр╕Чр╕╡р╣Ир╕Др╕▓р╕Фр╣Др╕зр╣Й (р╣Др╕бр╣Ир╕бр╕╡р╕Др╕нр╕ер╕▒р╕бр╕Щр╣М name, months, etc.)

## ЁЯЫая╕П р╕зр╕┤р╕Шр╕╡р╕Бр╕▓р╕гр╕гр╕▒р╕Щ Migration (2 р╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щ)

### р╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щр╕Чр╕╡р╣И 1: р╕гр╕▒р╕Щ Migration р╕лр╕ер╕▒р╕Б
1. р╣Ар╕Ыр╕┤р╕Ф [Supabase Dashboard](https://supabase.com/dashboard)
2. р╣Ар╕ер╕╖р╕нр╕Бр╣Вр╕Ыр╕гр╣Ар╕Ир╕Др╕Вр╕нр╕Зр╕Др╕╕р╕У
3. р╣Др╕Ыр╕Чр╕╡р╣Ир╣Ар╕бр╕Щр╕╣ **SQL Editor** р╕Чр╕▓р╕Зр╕Фр╣Йр╕▓р╕Щр╕Лр╣Йр╕▓р╕в
4. р╕Др╕ер╕┤р╕Б **New Query** р╣Ар╕Юр╕╖р╣Ир╕нр╕кр╕гр╣Йр╕▓р╕З query р╣Гр╕лр╕бр╣И
5. р╕Др╕▒р╕Фр╕ер╕нр╕Бр╣Ар╕Щр╕╖р╣Йр╕нр╕лр╕▓р╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Фр╕Ир╕▓р╕Бр╣Др╕Яр╕ер╣М `manual_migration.sql`
6. р╕зр╕▓р╕Зр╣Гр╕Щр╕лр╕Щр╣Йр╕▓р╕Хр╣Ир╕▓р╕З SQL Editor р╣Бр╕ер╕░р╕Др╕ер╕┤р╕Б **Run**

### р╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щр╕Чр╕╡р╣И 2: р╕гр╕▒р╕Щ Migration р╕кр╕│р╕лр╕гр╕▒р╕Ъ installment_plans
1. р╕кр╕гр╣Йр╕▓р╕З **New Query** р╕нр╕╡р╕Бр╕Др╕гр╕▒р╣Йр╕З
2. р╣Ар╕ер╕╖р╕нр╕Бр╣Др╕Яр╕ер╣Мр╕Чр╕╡р╣Ир╣Ар╕лр╕бр╕▓р╕░р╕кр╕б:
   - **ЁЯеЗ р╣Бр╕Щр╕░р╕Щр╕│р╕Чр╕╡р╣Ир╕кр╕╕р╕Ф**: `minimal_installment_plans_migration.sql` (р╣Ар╕гр╕╡р╕вр╕Ър╕Зр╣Ир╕▓р╕в р╣Бр╕Щр╣Ир╕Щр╕нр╕Щ)
   - **ЁЯеИ р╕Чр╕▓р╕Зр╣Ар╕ер╕╖р╕нр╕Б**: `ultra_safe_installment_plans_migration.sql` (р╕Др╕гр╕Ър╕Цр╣Йр╕зр╕Щ р╣Бр╕Бр╣Йр╣Др╕Вр╣Бр╕ер╣Йр╕з)
   - **ЁЯеЙ р╕кр╕│р╕гр╕нр╕З**: `simple_installment_plans_migration.sql` (р╣Бр╕Бр╣Йр╣Др╕Вр╣Бр╕ер╣Йр╕з)
3. р╕Др╕▒р╕Фр╕ер╕нр╕Бр╣Ар╕Щр╕╖р╣Йр╕нр╕лр╕▓р╕Ир╕▓р╕Бр╣Др╕Яр╕ер╣Мр╕Чр╕╡р╣Ир╣Ар╕ер╕╖р╕нр╕Бр╣Бр╕ер╕░р╕зр╕▓р╕Зр╣Гр╕Щ SQL Editor
4. р╕Др╕ер╕┤р╕Б **Run**

**р╕лр╕бр╕▓р╕вр╣Ар╕лр╕Хр╕╕**: 
- р╕Ир╕▓р╕Бр╕Бр╕▓р╕гр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Юр╕Ър╕зр╣Ир╕▓р╕Др╕нр╕ер╕▒р╕бр╕Щр╣Мр╕Чр╕╡р╣Ир╕Ир╕│р╣Ар╕Ыр╣Зр╕Щр╕Ир╕гр╕┤р╕Зр╣Ж р╕бр╕╡р╣Ар╕Юр╕╡р╕вр╕З `plan_number` р╣Бр╕ер╕░ `total_amount`
- р╣Др╕Яр╕ер╣М `minimal_installment_plans_migration.sql` р╣Ар╕Ыр╣Зр╕Щр╣Ар╕зр╕нр╕гр╣Мр╕Кр╕▒р╕Щр╕Чр╕╡р╣Ир╣Ар╕гр╕╡р╕вр╕Ър╕Зр╣Ир╕▓р╕вр╣Бр╕ер╕░р╣Бр╕Щр╣Ир╕Щр╕нр╕Щр╕Чр╕╡р╣Ир╕кр╕╕р╕Ф

### р╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щр╕Чр╕╡р╣И 3: р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣М
р╕гр╕▒р╕Щр╕Др╕│р╕кр╕▒р╣Ир╕Зр╕Щр╕╡р╣Йр╣Гр╕Щр╣Ар╕Чр╕нр╕гр╣Мр╕бр╕┤р╕Щр╕▒р╕ер╣Ар╕Юр╕╖р╣Ир╕нр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ:
```bash
npm run check-db
```

## ЁЯУД р╣Ар╕Щр╕╖р╣Йр╕нр╕лр╕▓р╕Вр╕нр╕З Migration Script

### 1. р╕кр╕гр╣Йр╕▓р╕Зр╕Хр╕▓р╕гр╕▓р╕Зр╣Гр╕лр╕бр╣И
- **guarantors** - р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Ьр╕╣р╣Йр╕Др╣Йр╕│р╕Ыр╕гр╕░р╕Бр╕▒р╕Щ
- **contract_history** - р╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤р╕Бр╕▓р╕гр╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щр╣Бр╕Ыр╕ер╕Зр╕кр╕▒р╕Нр╕Нр╕▓
- **contract_documents** - р╣Ар╕нр╕Бр╕кр╕▓р╕гр╣Бр╕Щр╕Ъ

### 2. р╣Ар╕Юр╕┤р╣Ир╕бр╕Др╕нр╕ер╕▒р╕бр╕Щр╣Мр╣Гр╕Щр╕Хр╕▓р╕гр╕▓р╕Зр╣Ар╕Фр╕┤р╕б
- **customers** - р╣Ар╕Юр╕┤р╣Ир╕б 11 р╕Др╕нр╕ер╕▒р╕бр╕Щр╣Мр╣Гр╕лр╕бр╣И
- **installment_contracts** - р╣Ар╕Юр╕┤р╣Ир╕б 8 р╕Др╕нр╕ер╕▒р╕бр╕Щр╣Мр╣Гр╕лр╕бр╣И
- **installment_payments** - р╣Ар╕Юр╕┤р╣Ир╕б 5 р╕Др╕нр╕ер╕▒р╕бр╕Щр╣Мр╣Гр╕лр╕бр╣И
- **installment_plans** - р╣Ар╕Юр╕┤р╣Ир╕б 3 р╕Др╕нр╕ер╕▒р╕бр╕Щр╣Мр╣Гр╕лр╕бр╣И

### 3. р╕кр╕гр╣Йр╕▓р╕З Indexes р╣Бр╕ер╕░ Constraints
- Indexes р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Бр╕▓р╕гр╕Др╣Йр╕Щр╕лр╕▓р╕Чр╕╡р╣Ир╣Ар╕гр╣Зр╕зр╕Вр╕╢р╣Йр╕Щ
- Foreign Key Constraints р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Др╕зр╕▓р╕бр╕кр╕▒р╕бр╕Юр╕▒р╕Щр╕Шр╣М
- Unique Constraints р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Чр╕╡р╣Ир╣Др╕бр╣Ир╕Лр╣Йр╕│

### 4. р╣Ар╕Юр╕┤р╣Ир╕б Functions р╣Бр╕ер╕░ Triggers
- Function р╕кр╕│р╕лр╕гр╕▒р╕Ър╕нр╕▒р╕Ыр╣Ар╕Фр╕Х `updated_at`
- Triggers р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Хр╕▓р╕гр╕▓р╕З guarantors

### 5. р╣Ар╕Юр╕┤р╣Ир╕бр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕З
- р╣Бр╕Ьр╕Щр╕Ьр╣Ир╕нр╕Щр╕Кр╕│р╕гр╕░ 5 р╣Бр╕Ьр╕Щ
- р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Юр╕╖р╣Йр╕Щр╕Рр╕▓р╕Щр╕кр╕│р╕лр╕гр╕▒р╕Ър╕Бр╕▓р╕гр╕Чр╕Фр╕кр╕нр╕Ъ

## тЬЕ р╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣Мр╕Чр╕╡р╣Ир╕Др╕▓р╕Фр╕лр╕зр╕▒р╕З

р╕лр╕ер╕▒р╕Зр╕Ир╕▓р╕Бр╕гр╕▒р╕Щ migration р╕кр╕│р╣Ар╕гр╣Зр╕И р╕Др╕╕р╕Ур╕Ир╕░р╣Др╕Фр╣Й:

### р╕Хр╕▓р╕гр╕▓р╕Зр╕Чр╕╡р╣Ир╕Др╕гр╕Ър╕Цр╣Йр╕зр╕Щ:
```
тЬЕ customers (р╕Юр╕гр╣Йр╕нр╕бр╕Др╕нр╕ер╕▒р╕бр╕Щр╣Мр╣Гр╕лр╕бр╣И 11 р╕Др╕нр╕ер╕▒р╕бр╕Щр╣М)
тЬЕ guarantors (р╕Хр╕▓р╕гр╕▓р╕Зр╣Гр╕лр╕бр╣И)
тЬЕ installment_plans (р╕Юр╕гр╣Йр╕нр╕бр╕Др╕нр╕ер╕▒р╕бр╕Щр╣Мр╣Гр╕лр╕бр╣И 3 р╕Др╕нр╕ер╕▒р╕бр╕Щр╣М)
тЬЕ installment_contracts (р╕Юр╕гр╣Йр╕нр╕бр╕Др╕нр╕ер╕▒р╕бр╕Щр╣Мр╣Гр╕лр╕бр╣И 8 р╕Др╕нр╕ер╕▒р╕бр╕Щр╣М)
тЬЕ installment_payments (р╕Юр╕гр╣Йр╕нр╕бр╕Др╕нр╕ер╕▒р╕бр╕Щр╣Мр╣Гр╕лр╕бр╣И 5 р╕Др╕нр╕ер╕▒р╕бр╕Щр╣М)
тЬЕ contract_history (р╕Хр╕▓р╕гр╕▓р╕Зр╣Гр╕лр╕бр╣И)
тЬЕ contract_documents (р╕Хр╕▓р╕гр╕▓р╕Зр╣Гр╕лр╕бр╣И)
```

### р╕Яр╕╡р╣Ар╕Ир╕нр╕гр╣Мр╕Чр╕╡р╣Ир╕Юр╕гр╣Йр╕нр╕бр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щ:
- ЁЯОп Workflow р╕Бр╕▓р╕гр╕кр╕гр╣Йр╕▓р╕Зр╕кр╕▒р╕Нр╕Нр╕▓р╣Гр╕лр╕бр╣И 5 р╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щ
- ЁЯСе р╕гр╕░р╕Ър╕Ър╕Ир╕▒р╕Фр╕Бр╕▓р╕гр╕Ьр╕╣р╣Йр╕Др╣Йр╕│р╕Ыр╕гр╕░р╕Бр╕▒р╕Щ
- ЁЯУК р╕Бр╕▓р╕гр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Др╕зр╕▓р╕бр╣Ар╕кр╕╡р╣Ир╕вр╕Зр╕нр╕▒р╕Хр╣Вр╕Щр╕бр╕▒р╕Хр╕┤
- ЁЯУБ р╕гр╕░р╕Ър╕Ър╕Ир╕▒р╕Фр╕Бр╕▓р╕гр╣Ар╕нр╕Бр╕кр╕▓р╕г
- ЁЯУИ р╕Бр╕▓р╕гр╕Хр╕┤р╕Фр╕Хр╕▓р╕бр╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤р╕Бр╕▓р╕гр╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щр╣Бр╕Ыр╕ер╕З

## ЁЯФз р╕Бр╕▓р╕гр╣Бр╕Бр╣Йр╣Др╕Вр╕Ыр╕▒р╕Нр╕лр╕▓

### р╕Цр╣Йр╕▓ Migration р╕ер╣Йр╕бр╣Ар╕лр╕ер╕з:

#### 1. р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ Permissions
```sql
-- р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕кр╕┤р╕Чр╕Шр╕┤р╣Мр╕Вр╕нр╕З user р╕Ыр╕▒р╕Ир╕Ир╕╕р╕Ър╕▒р╕Щ
SELECT current_user, session_user;
```

#### 2. р╕гр╕▒р╕Щ Migration р╕Чр╕╡р╕ер╕░р╕кр╣Ир╕зр╕Щ
р╣Бр╕Чр╕Щр╕Чр╕╡р╣Ир╕Ир╕░р╕гр╕▒р╕Щр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Фр╕Юр╕гр╣Йр╕нр╕бр╕Бр╕▒р╕Щ р╣Гр╕лр╣Йр╕гр╕▒р╕Щр╕Чр╕╡р╕ер╕░р╕кр╣Ир╕зр╕Щ:

```sql
-- р╕кр╣Ир╕зр╕Щр╕Чр╕╡р╣И 1: р╕кр╕гр╣Йр╕▓р╕Зр╕Хр╕▓р╕гр╕▓р╕З guarantors
CREATE TABLE IF NOT EXISTS guarantors (...);

-- р╕кр╣Ир╕зр╕Щр╕Чр╕╡р╣И 2: р╕кр╕гр╣Йр╕▓р╕Зр╕Хр╕▓р╕гр╕▓р╕З contract_history
CREATE TABLE IF NOT EXISTS contract_history (...);

-- р╣Бр╕ер╕░р╕Хр╣Ир╕нр╣Др╕Ы...
```

#### 3. р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ Error Messages
- `relation already exists` = р╕Хр╕▓р╕гр╕▓р╕Зр╕бр╕╡р╕нр╕вр╕╣р╣Ир╣Бр╕ер╣Йр╕з (р╕Ыр╕Бр╕Хр╕┤)
- `column already exists` = р╕Др╕нр╕ер╕▒р╕бр╕Щр╣Мр╕бр╕╡р╕нр╕вр╕╣р╣Ир╣Бр╕ер╣Йр╕з (р╕Ыр╕Бр╕Хр╕┤)
- `permission denied` = р╣Др╕бр╣Ир╕бр╕╡р╕кр╕┤р╕Чр╕Шр╕┤р╣М (р╕Хр╕┤р╕Фр╕Хр╣Ир╕н admin)

### р╕Цр╣Йр╕▓р╕вр╕▒р╕Зр╕бр╕╡р╕Ыр╕▒р╕Нр╕лр╕▓:

#### р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╣Вр╕Др╕гр╕Зр╕кр╕гр╣Йр╕▓р╕Зр╕Хр╕▓р╕гр╕▓р╕З:
```sql
-- р╕Фр╕╣р╣Вр╕Др╕гр╕Зр╕кр╕гр╣Йр╕▓р╕Зр╕Хр╕▓р╕гр╕▓р╕З
\d guarantors
\d customers
\d installment_contracts

-- р╕лр╕гр╕╖р╕нр╣Гр╕Кр╣Й
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'guarantors';
```

## ЁЯУЮ р╕Бр╕▓р╕гр╕Вр╕нр╕Др╕зр╕▓р╕бр╕Кр╣Ир╕зр╕вр╣Ар╕лр╕ер╕╖р╕н

р╕Цр╣Йр╕▓р╕вр╕▒р╕Зр╕бр╕╡р╕Ыр╕▒р╕Нр╕лр╕▓:
1. р╕гр╕▒р╕Щр╕Др╕│р╕кр╕▒р╣Ир╕З `npm run check-db` р╣Бр╕ер╕░р╕кр╣Ир╕Зр╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣М
2. р╕кр╣Ир╕З error message р╕Чр╕╡р╣Ир╣Др╕Фр╣Йр╕Ир╕▓р╕Б SQL Editor
3. р╕гр╕░р╕Ър╕╕р╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щр╕Чр╕╡р╣Ир╕ер╣Йр╕бр╣Ар╕лр╕ер╕з

## ЁЯОЙ р╕лр╕ер╕▒р╕Зр╕Ир╕▓р╕Б Migration р╕кр╕│р╣Ар╕гр╣Зр╕И

1. **р╕Чр╕Фр╕кр╕нр╕Ър╕гр╕░р╕Ър╕Ъ**: р╣Ар╕Ыр╕┤р╕Фр╕лр╕Щр╣Йр╕▓ Installments р╣Бр╕ер╕░р╕Чр╕Фр╕кр╕нр╕Ър╕кр╕гр╣Йр╕▓р╕Зр╕кр╕▒р╕Нр╕Нр╕▓р╣Гр╕лр╕бр╣И
2. **р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕е**: р╕Фр╕╣р╕зр╣Ир╕▓р╕Хр╕▓р╕гр╕▓р╕Зр╣Бр╕ер╕░р╕Др╕нр╕ер╕▒р╕бр╕Щр╣Мр╕Цр╕╣р╕Бр╕кр╕гр╣Йр╕▓р╕Зр╕Др╕гр╕Ър╕Цр╣Йр╕зр╕Щ
3. **р╣Ар╕гр╕┤р╣Ир╕бр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щ**: р╕гр╕░р╕Ър╕Ър╕Юр╕гр╣Йр╕нр╕бр╕кр╕│р╕лр╕гр╕▒р╕Ър╕Бр╕▓р╕гр╕Ир╕▒р╕Фр╕Бр╕▓р╕гр╕кр╕▒р╕Нр╕Нр╕▓р╕Ьр╣Ир╕нр╕Щр╕Кр╕│р╕гр╕░р╣Бр╕Ър╕Ър╕Др╕гр╕Ър╕Цр╣Йр╕зр╕Щ

---

**р╕лр╕бр╕▓р╕вр╣Ар╕лр╕Хр╕╕**: Migration script р╕Щр╕╡р╣Йр╣Гр╕Кр╣Й `IF NOT EXISTS` р╣Бр╕ер╕░ `ADD COLUMN IF NOT EXISTS` р╕Фр╕▒р╕Зр╕Щр╕▒р╣Йр╕Щр╕кр╕▓р╕бр╕▓р╕гр╕Цр╕гр╕▒р╕Щр╕Лр╣Йр╕│р╣Др╕Фр╣Йр╣Вр╕Фр╕вр╣Др╕бр╣Ир╣Ар╕Бр╕┤р╕Фр╕Ыр╕▒р╕Нр╕лр╕▓