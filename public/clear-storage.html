<!DOCTYPE html>
<html>
<head>
    <title>Clear Storage & Test Environment</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 5px; }
        button { padding: 10px 20px; margin: 10px 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .danger { background: #dc3545; }
        .danger:hover { background: #c82333; }
    </style>
</head>
<body>
    <h1>üßπ Clear Storage & Test Environment</h1>
    
    <div>
        <h2>üóëÔ∏è Storage Management</h2>
        <button onclick="clearStorage()" class="danger">Clear All localStorage</button>
        <button onclick="showStorage()">Show localStorage Contents</button>
        <div id="storage-info"></div>
    </div>
    
    <div>
        <h2>üîß Environment Variables Test</h2>
        <button onclick="testEnvironment()">Test Environment Variables</button>
        <div id="env-results"></div>
    </div>
    
    <div>
        <h2>üîó Database Connection Test</h2>
        <button onclick="testConnection()">Test Database Connection</button>
        <div id="connection-results"></div>
    </div>

    <script type="module">
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á localStorage
        window.clearStorage = function() {
            try {
                const keys = Object.keys(localStorage);
                console.log('üóëÔ∏è Clearing localStorage keys:', keys);
                
                localStorage.clear();
                
                document.getElementById('storage-info').innerHTML = 
                    '<p class="success">‚úÖ localStorage cleared successfully!</p>';
                
                // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
                
            } catch (error) {
                console.error('‚ùå Error clearing localStorage:', error);
                document.getElementById('storage-info').innerHTML = 
                    `<p class="error">‚ùå Error: ${error.message}</p>`;
            }
        };

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á localStorage
        window.showStorage = function() {
            try {
                const keys = Object.keys(localStorage);
                let html = '<h3>üì¶ localStorage Contents:</h3>';
                
                if (keys.length === 0) {
                    html += '<p>Empty</p>';
                } else {
                    html += '<ul>';
                    keys.forEach(key => {
                        const value = localStorage.getItem(key);
                        const displayValue = value && value.length > 100 ? 
                            value.substring(0, 100) + '...' : value;
                        html += `<li><strong>${key}:</strong> ${displayValue}</li>`;
                    });
                    html += '</ul>';
                }
                
                document.getElementById('storage-info').innerHTML = html;
            } catch (error) {
                document.getElementById('storage-info').innerHTML = 
                    `<p class="error">‚ùå Error: ${error.message}</p>`;
            }
        };

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö environment variables
        window.testEnvironment = function() {
            const resultDiv = document.getElementById('env-results');
            
            const env = {
                VITE_SUPABASE_URL: import.meta.env.VITE_SUPABASE_URL,
                VITE_SUPABASE_ANON_KEY: import.meta.env.VITE_SUPABASE_ANON_KEY,
                VITE_SUPABASE_SERVICE_ROLE_KEY: import.meta.env.VITE_SUPABASE_SERVICE_ROLE_KEY,
                VITE_USE_SERVICE_ROLE: import.meta.env.VITE_USE_SERVICE_ROLE
            };

            console.log('üîß Environment Variables:', env);

            let html = '<h3>üìä Environment Status:</h3><ul>';
            let allValid = true;

            for (const [key, value] of Object.entries(env)) {
                const hasValue = value && value !== 'undefined';
                const status = hasValue ? '‚úÖ' : '‚ùå';
                const className = hasValue ? 'success' : 'error';
                
                if (!hasValue) allValid = false;
                
                html += `<li class="${className}"><strong>${key}:</strong> ${status} ${hasValue ? 'Set' : 'Missing'}</li>`;
            }

            html += '</ul>';

            if (allValid) {
                const useServiceRole = env.VITE_USE_SERVICE_ROLE === 'true';
                const keyType = useServiceRole ? 'Service Role Key' : 'Anon Key';
                html += `<p class="success">‚úÖ All environment variables are set! Using ${keyType}</p>`;
            } else {
                html += `<p class="error">‚ùå Some environment variables are missing. Check your .env.local file.</p>`;
            }

            resultDiv.innerHTML = html;
        };

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
        window.testConnection = async function() {
            const resultDiv = document.getElementById('connection-results');
            resultDiv.innerHTML = '<p class="warning">üîÑ Testing connection...</p>';

            try {
                const env = {
                    VITE_SUPABASE_URL: import.meta.env.VITE_SUPABASE_URL,
                    VITE_SUPABASE_ANON_KEY: import.meta.env.VITE_SUPABASE_ANON_KEY,
                    VITE_SUPABASE_SERVICE_ROLE_KEY: import.meta.env.VITE_SUPABASE_SERVICE_ROLE_KEY,
                    VITE_USE_SERVICE_ROLE: import.meta.env.VITE_USE_SERVICE_ROLE
                };

                if (!env.VITE_SUPABASE_URL) {
                    throw new Error('VITE_SUPABASE_URL is not set');
                }

                const useServiceRole = env.VITE_USE_SERVICE_ROLE === 'true';
                const selectedKey = useServiceRole ? env.VITE_SUPABASE_SERVICE_ROLE_KEY : env.VITE_SUPABASE_ANON_KEY;
                const keyType = useServiceRole ? 'Service Role Key' : 'Anon Key';

                if (!selectedKey) {
                    throw new Error(`${keyType} is not set`);
                }

                const { createClient } = await import('@supabase/supabase-js');
                const supabase = createClient(env.VITE_SUPABASE_URL, selectedKey, {
                    auth: {
                        autoRefreshToken: false,
                        persistSession: false
                    }
                });

                console.log(`üîó Testing connection with ${keyType}...`);

                const { data, error } = await supabase
                    .from('branches')
                    .select('count', { count: 'exact', head: true });

                if (error) {
                    console.error('‚ùå Connection error:', error);
                    resultDiv.innerHTML = `<p class="error">‚ùå Connection Error: ${error.message}</p>`;
                } else {
                    console.log('‚úÖ Connection successful!');
                    resultDiv.innerHTML = `<p class="success">‚úÖ Connection successful! Using ${keyType}</p>`;
                }

            } catch (err) {
                console.error('üí• Test failed:', err);
                resultDiv.innerHTML = `<p class="error">‚ùå Test Failed: ${err.message}</p>`;
            }
        };

        // ‡∏£‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
        window.addEventListener('load', () => {
            showStorage();
            testEnvironment();
        });
    </script>
</body>
</html>